# Visual Studio プロジェクトと共通部品のGit運用マニュアル

## 概要

このドキュメントは、Visual Studio を使用したソフトウェア開発において、メインプロジェクトと共通部品のソースコードを別々の場所に配置し、Git で効率的にバージョン管理を行うための手順を説明します。特に、**Gitサブモジュール**を活用した運用方法に焦点を当てます。

### 想定するディレクトリ構成

* **メインプロジェクト:** `c:\source\myapp`
    * 例: `c:\source\myapp\myapp.sln` (`Visual Studio ソリューションファイル`)
    * 例: `c:\source\myapp\myapp.csproj` (`C# プロジェクトファイル`)
* **共通部品:** `c:\source\common`
    * 例: `c:\source\common\Utility.cs` (`共通のC#ソースファイル`)

### この運用のメリット

* **独立した管理:** メインプロジェクトと共通部品がそれぞれ独立したGitリポジトリとして管理されます。これにより、共通部品単体での開発やバージョン管理が容易になります。
* **バージョンの固定:** メインプロジェクトは、特定の時点の共通部品のバージョン（コミット）を正確に参照できます。これにより、共通部品の変更がメインプロジェクトに予期せぬ影響を与えるのを防ぎ、プロジェクトの安定性を保てます。
* **再利用性:** 共通部品を他の複数のプロジェクトで簡単に再利用できます。各プロジェクトは必要に応じて異なるバージョンの共通部品を参照できます。
* **クリーンな構造:** プロジェクトディレクトリが散らからず、論理的な構造を保てます。

---

## 前提条件

* Gitがインストールされており、基本的なコマンドライン操作（`cd`, `git init`, `git add`, `git commit` など）を理解している。
* Visual Studioがインストールされている。

---

## 導入手順

### ステップ1: 共通部品リポジトリの準備

まず、`c:\source\common` にある共通部品を独立したGitリポジトリとして設定します。

1.  **共通部品のディレクトリに移動:**
    コマンドプロンプトまたはGit Bashを開き、`c:\source\common` ディレクトリへ移動します。
    ```bash
    cd c:\source\common
    ```
2.  **Gitリポジトリの初期化:**
    このディレクトリをGitリポジトリとして初期化します。
    ```bash
    git init
    ```
3.  **ファイルをGitに追加し、初回コミット:**
    共通部品のすべてのファイルをGitの追跡対象に追加し、最初のコミットを行います。
    ```bash
    git add .
    git commit -m "Initial commit for common components"
    ```
4.  **(任意) リモートリポジトリへのプッシュ:**
    GitHubやAzure DevOpsなどのリモートリポジトリに共通部品をプッシュしておくと、バックアップやチームメンバーとの共有に非常に便利です。
    ```bash
    git remote add origin <共通部品のリモートリポジトリURL>
    git push -u origin master
    ```
    *もしリモートリポジトリを使わない場合でも、この運用は可能ですが、将来的な共同作業やバックアップのために設定することを強く推奨します。*

---

### ステップ2: メインプロジェクトへのサブモジュールの追加

次に、`c:\source\myapp` にあるメインプロジェクトのGitリポジトリに、共通部品リポジトリを**サブモジュール**として追加します。

1.  **メインプロジェクトのディレクトリに移動:**
    コマンドプロンプトまたはGit Bashを開き、`c:\source\myapp` ディレクトリへ移動します。
    ```bash
    cd c:\source\myapp
    ```
2.  **Gitリポジトリの初期化（未初期化の場合）:**
    もし `c:\source\myapp` がまだGitリポジトリでない場合は、初期化します。
    ```bash
    git init
    ```
3.  **共通部品をサブモジュールとして追加:**
    以下のコマンドで共通部品リポジトリをサブモジュールとして追加します。
    ```bash
    git submodule add https://github.com/km-ume6/CommonFiles common_parts
    ```
    * `"C:\Users\ume6\OneDrive - ume6\Code\CommonFiles"`: ステップ1で作成した共通部品リポジトリのパスです。Windowsのパスはスラッシュ `/` で区切るのがGitでは一般的です。
    * `common_parts`: メインプロジェクトの `c:\source\myapp` の中に作成されるディレクトリ名です。このディレクトリの中に、共通部品のファイルがクローンされ、メインプロジェクトのGitから参照可能になります。

4.  **サブモジュールの追加をコミット:**
    サブモジュールを追加すると、メインプロジェクトのリポジトリに`.gitmodules` ファイルと `common_parts` ディレクトリが新しく作成されます。これらの変更をメインプロジェクトのリポジトリにコミットします。
    ```bash
    git add .
    git commit -m "Add common components as a submodule"
    ```
5.  **(任意) メインプロジェクトのリモートリポジトリへのプッシュ:**
    メインプロジェクトをリモートリポジトリにプッシュします。
    ```bash
    git remote add origin <メインプロジェクトのリモートリポジトリURL>
    git push -u origin master
    ```

---

### ステップ3: Visual Studio プロジェクトへの共通部品の追加

メインプロジェクトの `myapp.csproj` から、サブモジュールとして追加した共通部品のソースファイルを参照できるようにします。

1.  **Visual Studioでソリューションを開く:**
    Visual Studio で `c:\source\myapp\myapp.sln` を開きます。
2.  **既存の項目として追加:**
    ソリューションエクスプローラーで、`myapp` プロジェクト（`.csproj` ファイル）を右クリックし、「**追加**」>「**既存の項目**」を選択します。
3.  **サブモジュール内のファイルを選択:**
    ファイル選択ダイアログが表示されるので、`c:\source\myapp\common_parts` ディレクトリ（サブモジュールが配置された場所）に移動します。
4.  **ソースファイルを追加:**
    プロジェクトに追加したい共通部品のソースファイル（例: `.cs` ファイルなど）をすべて選択し、「**追加**」ボタンをクリックします。
    * **重要:** この際、ダイアログ右下の「追加」ボタンのドロップダウンメニューで**「リンクとして追加」は選択しないでください。** サブモジュールとして追加されたファイルは、すでにプロジェクトディレクトリ内に物理的に存在しているため、通常の「追加」で問題ありません。

これで、Visual Studio のプロジェクトも、共通部品のソースファイルを直接参照するようになります。

---

## 日常の運用とサブモジュールの管理

この設定が完了したら、日々の開発は以下の流れで行います。

### 1. 共通部品を変更する場合

共通部品のソースファイルに変更を加える際は、**共通部品リポジトリ内で**変更をコミットし、プッシュします。

1.  `c:\source\myapp\common_parts` ディレクトリ（または、共通部品を直接開発している場合は元の `c:\source\common` ディレクトリ）に移動します。
2.  ソースファイルを変更し、その変更をGitに追加（`add`）、コミット（`commit`）、プッシュ（`push`）します。
    ```bash
    cd c:\source\myapp\common_parts
    # ソースファイルを変更
    git add .
    git commit -m "Fix bug in common utility"
    git push origin master # または他の適切なブランチ
    ```
3.  この変更をメインプロジェクトに反映させるには、「メインプロジェクトで共通部品の変更を取り込む場合」の手順を実行してください。

### 2. メインプロジェクトで共通部品の変更を取り込む場合

共通部品の最新バージョンや特定のバージョンをメインプロジェクトに反映させたい場合、以下の手順を実行します。

1.  **メインプロジェクトのディレクトリに移動:**
    ```bash
    cd c:\source\myapp
    ```
2.  **サブモジュールを更新:**
    以下のコマンドで、サブモジュールの最新のコミットを取り込みます。
    ```bash
    git submodule update --remote --merge
    ```
    * このコマンドは、サブモジュールが指し示すコミット（ポインタ）を更新し、実際のファイルを最新の状態にします。
    * 特定の過去のバージョンに戻したい場合は、`cd common_parts` でサブモジュールディレクトリに入り、`git checkout <コミットハッシュまたはタグ>` を実行することもできます。
3.  **メインプロジェクトの変更をコミット:**
    サブモジュールが指し示すコミットが変更されたことを、メインプロジェクトのGitが認識します。このサブモジュールのポインタの変更をメインプロジェクトのリポジトリにコミットし、プッシュします。
    ```bash
    git add common_parts
    git commit -m "Update common components submodule to latest version"
    git push origin master
    ```

### 3. 他の人がメインプロジェクトをクローンする場合

新しい開発者がメインプロジェクトのリポジトリをクローンした場合、サブモジュールの中身は空の状態です。以下のコマンドでサブモジュールを初期化し、クローンする必要があります。

1.  **メインプロジェクトをクローン:**
    ```bash
    git clone <メインプロジェクトのリモートリポジトリURL>
    cd myapp
    ```
2.  **サブモジュールを初期化してクローン:**
    ```bash
    git submodule update --init --recursive
    ```
    * `--recursive` オプションは、サブモジュールがさらに別のサブモジュールを持っている場合に、それらも自動的に初期化・クローンするために使います。

---

## よくある質問とトラブルシューティング

* **Q: 全てのGit操作はコマンドラインで行う必要がありますか？**
    * **A:** いいえ、そのようなことはありません。サブモジュールの**追加、初期化、更新**といった特定の操作にはコマンドラインが推奨されますが、日常的なコミット、プッシュ、プル、ブランチ管理など、ほとんどのGit操作はVisual StudioのGit機能や他のGUIツール（GitKraken, SourceTreeなど）で引き続き行えます。

* **Q: メインプロジェクトをクローンしたら、`common_parts` ディレクトリが空です。**
    * **A:** メインリポジトリをクローンしただけでは、サブモジュールの内容は自動的にクローンされません。`git submodule update --init --recursive` コマンドを実行して、サブモジュールを初期化し、内容をクローンしてください。

* **Q: 共通部品を間違ってメインプロジェクトに直接コミットしてしまいました。**
    * **A:** このような状況は避けるべきですが、もし発生した場合は、`git reset` や `git restore` などのコマンドを使って変更を取り消し、**共通部品リポジトリ（`c:\source\common` または `c:\source\myapp\common_parts` 内）**で正しいコミットとプッシュを行ってください。

* **Q: 共通部品の変更をプッシュした後、メインプロジェクトがその変更を認識しないのはなぜですか？**
    * **A:** 共通部品リポジトリへのプッシュだけでは、メインプロジェクトが参照する「共通部品のバージョンポインタ」は更新されません。メインプロジェクトのディレクトリで `git submodule update --remote --merge` を実行し、その後、メインプロジェクトの変更としてコミット・プッシュする必要があります。

---